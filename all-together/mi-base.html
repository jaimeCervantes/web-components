<script>
const APP = {};

{
  class MiBase extends HTMLElement {
    constructor () {
      super();
      // Preparar funcion getTemplate para buscar en el DOM una sola vez
      this.getTemplate = this.initTemplate(this.localName);
      // console.log(this.shadowRoot); // null, aun no tiene asigando shadow DOM
      this.attachShadow({ mode: 'open' }); // adjuntar shadow DOM
      // console.log(this.shadowRoot); // Es el nodo raiz del shadow DOM dentro de un custom element
      // this.shadowRoot.host === this
      this.props = this.getProps(this.attributes); 
      // Plantila inicial, a veces no existe interpolaciones
      this.shadowRoot.innerHTML = this.getTemplate();
    }

    static get is() {
      return 'mi-base';
    }

    attributeChangedCallback(attrName, oldVal, newVal) {
      if(this.props.find(elem => elem.name === attrName)) {
        this.props = this.props.map(attr => {
          if (attr.name === attrName) {
            return { name: attrName, value: newVal };
          }

          return attr
        });

        // the shadow DOM in this point is already defined, so we can access to it with this.shadowRoot property
        this.shadowRoot.innerHTML = this.render(this.getTemplate(), this.props);
      }
    }

    initTemplate (localName) {
      let tplMemo = "";

      return function () {
        if (typeof(tplMemo) === 'string' && tplMemo !== '') {
          return tplMemo
        }

        // Los query selector solo se ejecutan una vez, las proximas veces, sieplemente regresamos tplMemo
        const link = document.querySelector(`link#${localName}[rel="import"]`);
        const tpl = link.import.querySelector('template');

        tplMemo = tpl.innerHTML
        return tplMemo;
      }
    }

    getProps (attributes) {
      // set Attributes as props to future interpolation
      return Array.from(attributes).map(attr => {
        return { name: attr.name, value: attr.value };
      });
    }

    render (stringTemplate, props) {
      return props.reduce((acc, current) => {
        return acc.replace(`{{${current.name}}}`, current.value);
      }, stringTemplate);
    }
  }

  APP.Element = MiBase;
}
</script>